<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lee's RS Scanner (Client-Side)</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.png') }}">
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #00e676;
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --danger-color: #ff5252;
            --border-color: #333;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            margin-top: 40px;
            text-align: center;
            flex-grow: 1;
        }

        h1 {
            margin-bottom: 30px;
        }

        .info-box {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .highlight-danger {
            color: var(--danger-color);
            font-weight: bold;
        }

        button {
            background-color: var(--primary-color);
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        #loading-ui {
            display: none;
            margin-top: 30px;
        }

        .spinner {
            border: 4px solid #333;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        #debug-log {
            width: 100%;
            height: 100px;
            background-color: #000;
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            text-align: left;
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #333;
            overflow-y: scroll;
            display: none;
        }

        #result-area {
            display: none;
            margin-top: 40px;
        }

        .btn-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 15px;
        }

        .download-btn {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            transition: 0.2s;
            cursor: pointer;
        }

        .download-btn:hover {
            background-color: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--surface-color);
            font-size: 13px;
        }

        th,
        td {
            text-align: left;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            cursor: pointer;
            user-select: none;
            background-color: #252525;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
        }

        th:hover {
            background-color: #333;
        }

        .rs-pos {
            color: #00e676;
        }

        .rs-neg {
            color: #ff5252;
        }

        footer {
            width: 100%;
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid var(--border-color);
            margin-top: 50px;
            padding-bottom: 30px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Lee's RS Scanner (Client-Side)</h1>

        <div class="info-box">
            <p>1. <strong>Solution</strong>: Vercel IP ì°¨ë‹¨ì„ í”¼í•´ <strong>ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì•¼í›„ ë°ì´í„°ë¥¼ ìˆ˜ì§‘</strong>í•©ë‹ˆë‹¤.<br>
                2. <strong>Proxy</strong>: CORS ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ê³µìš© í”„ë¡ì‹œ(corsproxy.io ë“±)ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹œë„í•©ë‹ˆë‹¤.<br>
                3. <strong>Data</strong>: ì‹¤ì‹œê°„ ì£¼ê°€ ì°¨íŠ¸(v8/chart)ì™€ ì£¼ì‹ ìˆ˜(v10/quoteSummary)ë¥¼ ê²°í•©í•˜ì—¬ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
            <p class="highlight-danger">âš ï¸ ì£¼ì˜: ë¸Œë¼ìš°ì €ê°€ ì§ì ‘ í†µì‹ í•˜ë¯€ë¡œ ë„ˆë¬´ ë¹ ë¥¸ ë°˜ë³µ ìš”ì²­ì€ ìì œí•´ì£¼ì„¸ìš”.</p>
        </div>

        <button id="search-btn" onclick="startClientSideSearch()">ğŸ” ì¡°íšŒí•˜ê¸°</button>

        <div id="loading-ui">
            <div class="spinner"></div>
            <p>ë¸Œë¼ìš°ì €ê°€ ì—´ì‹¬íˆ ë°ì´í„°ë¥¼ ëª¨ìœ¼ê³  ìˆìŠµë‹ˆë‹¤... <span id="progress-percent"
                    style="font-weight:bold; color:var(--primary-color);">0%</span></p>
            <p id="progress-detail" style="font-size:12px; color:#888; margin-top:5px;">(ì¤€ë¹„ ì¤‘...)</p>
            <div id="debug-log"></div>
        </div>

        <div id="result-area">
            <div class="btn-group">
                <span id="result-count"
                    style="margin-right:15px; align-self:center; font-size:14px; color:#aaa;"></span>
                <a onclick="downloadExcel()" class="download-btn">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
            </div>

            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('Ticker')">Ticker â¬</th>
                        <th onclick="sortTable('MarketCap')">Market Cap ($) â¬</th>
                        <th onclick="sortTable('MarketCapRank')">MC Rank â¬</th>
                        <th onclick="sortTable('RS')">RS Score â¬</th>
                        <th onclick="sortTable('Sector')">Sector â¬</th>
                        <th onclick="sortTable('Industry')">Industry â¬</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <footer>
        RS scanner Â© 2026 | Idea by In-gyu Lee | Built by Dae-sik Min
    </footer>

    <script>
        let globalData = [];
        let sortDir = { key: '', asc: true };
        const BATCH_SIZE = 5;
        const DELAY_BETWEEN_BATCHES = 500;

        // PROXY LIST (ê°•ë ¥í•œ í”„ë¡ì‹œ ì¶”ê°€)
        const PROXIES = [
            "https://api.allorigins.win/raw?url=",
            "https://corsproxy.io/?url=",
            "https://api.codetabs.com/v1/proxy?quest="
        ];

        function log(msg) {
            const d = document.getElementById('debug-log');
            d.style.display = 'block';
            d.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
            console.log(msg);
        }

        async function fetchWithProxy(targetUrl) {
            let lastError = null;
            for (const proxyBase of PROXIES) {
                try {
                    const proxyUrl = proxyBase + encodeURIComponent(targetUrl);
                    // log(`Try Proxy: ${proxyBase}`);
                    const res = await fetch(proxyUrl);
                    if (res.ok) return res;
                    // log(`Failed ${proxyBase}: ${res.status}`);
                } catch (e) {
                    lastError = e;
                    // log(`Error ${proxyBase}: ${e.message}`);
                }
            }
            return null;
        }

        async function startClientSideSearch() {
            const btn = document.getElementById('search-btn');
            const loader = document.getElementById('loading-ui');
            const area = document.getElementById('result-area');
            const pPercent = document.getElementById('progress-percent');
            const pDetail = document.getElementById('progress-detail');
            const rCount = document.getElementById('result-count');
            const debugDiv = document.getElementById('debug-log');

            btn.disabled = true;
            loader.style.display = 'block';
            debugDiv.innerHTML = "<div>=== Start Log ===</div>"; // ì´ˆê¸°í™”
            area.style.display = 'none';
            globalData = [];
            rCount.innerText = "";

            try {
                // 1. Get Tickers
                pDetail.innerText = "í‹°ì»¤ ë¦¬ìŠ¤íŠ¸ ë¡œë”© ì¤‘...";
                const resInit = await fetch('/api/tickers');
                if (!resInit.ok) throw new Error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (Tickers)");
                const jsonInit = await resInit.json();
                if (jsonInit.status !== 'success') throw new Error(jsonInit.message);

                const allItems = jsonInit.data;
                const total = allItems.length;

                if (total === 0) {
                    alert("í‹°ì»¤ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    resetUI(btn, loader);
                    return;
                }

                // 2. Fetch QQQ
                pDetail.innerText = "ë²¤ì¹˜ë§ˆí¬(QQQ) ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (í”„ë¡ì‹œ í™•ì¸)";
                log("Fetching QQQ data...");

                let qqqData = null;
                try {
                    qqqData = await fetchYahooChart("QQQ");
                } catch (err) {
                    log("QQQ fetch fatal error: " + err.message);
                }

                if (!qqqData || qqqData.length < 50) {
                    log("QQQ fail. Retrying...");
                    // Retry once more
                    qqqData = await fetchYahooChart("QQQ");
                }

                if (!qqqData || qqqData.length < 50) {
                    throw new Error("QQQ ë°ì´í„°ë¥¼ ëª¨ë“  í”„ë¡ì‹œì—ì„œ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ í”„ë¡ì‹œ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }
                log(`QQQ Data OK. Points: ${qqqData.length}`);

                const qqqPerf = calculatePerformance(qqqData);
                log(`QQQ Perf: ${qqqPerf.toFixed(4)}`);

                // 3. Loop Tickers
                let processed = 0;
                let success = 0;

                for (let i = 0; i < total; i += BATCH_SIZE) {
                    const batch = allItems.slice(i, i + BATCH_SIZE);
                    pDetail.innerText = `ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (${i + 1} ~ ${Math.min(i + BATCH_SIZE, total)} / ${total})`;

                    const batchPromises = batch.map(async (item) => {
                        try {
                            const ticker = item.Ticker;
                            const [priceData, shares] = await Promise.all([
                                fetchYahooChart(ticker),
                                fetchYahooShares(ticker)
                            ]);

                            if (!priceData || priceData.length < 50) return null;

                            const itemPerf = calculatePerformance(priceData);
                            const currentPrice = priceData[priceData.length - 1].close;

                            let rs = 0;
                            if (qqqPerf !== 0) {
                                rs = (itemPerf / qqqPerf) - 1;
                            }

                            const finalShares = shares || 0;
                            const mcap = currentPrice * finalShares;

                            return {
                                Ticker: ticker,
                                Price: currentPrice,
                                RS: rs,
                                MarketCap: mcap,
                                Shares: finalShares,
                                Sector: item.Sector,
                                Industry: item.Industry
                            };

                        } catch (err) {
                            return null;
                        }
                    });

                    const results = await Promise.all(batchPromises);

                    const validResults = results.filter(r => r !== null);
                    globalData = globalData.concat(validResults);
                    success += validResults.length;
                    processed += batch.length;

                    // Log progress occasionally
                    if (processed % 20 === 0) log(`Processed ${processed}/${total}, Success: ${success}`);

                    const progress = Math.min(100, Math.round((processed / total) * 100));
                    pPercent.innerText = progress + '%';

                    await new Promise(r => setTimeout(r, DELAY_BETWEEN_BATCHES));
                }

                // 4. Finalize
                pDetail.innerText = "ìˆœìœ„ ê³„ì‚° ì¤‘...";
                calculateRanksAndSort();
                renderTable(globalData);

                rCount.innerText = `ì´ ${globalData.length}ê°œ ì„±ê³µ (ì‹œë„: ${total}ê°œ)`;

                loader.style.display = 'none';
                area.style.display = 'block';
                btn.innerText = 'âœ… ì¡°íšŒ ì™„ë£Œ (ë‹¤ì‹œ ì¡°íšŒ)';
                btn.disabled = false;

            } catch (e) {
                console.error(e);
                log("CRITICAL ERROR: " + e.message);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + e.message + "\n(ì„¸ë¶€ ë‚´ìš©ì€ ë¡œê·¸ í™•ì¸)");
                resetUI(btn, loader);
            }
        }

        // --- Yahoo Finance Helper (Client-Side) ---

        async function fetchYahooChart(ticker) {
            // v8 endpoint
            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=3mo`;

            try {
                const res = await fetchWithProxy(url);
                if (!res) return null;

                const json = await res.json();

                // Validate data structure
                // Some proxies return { contents: "..." } (like allorigins sometimes, but raw should be direct)
                // Let's check deep structure
                let result = null;
                if (json.chart && json.chart.result) {
                    result = json.chart.result[0];
                } else if (json.contents) {
                    // Maybe double parsed?
                    try {
                        const inner = JSON.parse(json.contents);
                        if (inner.chart && inner.chart.result) result = inner.chart.result[0];
                    } catch (e) { }
                }

                if (!result || !result.timestamp || !result.indicators.quote[0].adjclose) return null;

                const timestamps = result.timestamp;
                const adjCloses = result.indicators.quote[0].adjclose;

                const data = [];
                for (let i = 0; i < timestamps.length; i++) {
                    if (adjCloses[i]) {
                        data.push({ date: timestamps[i], close: adjCloses[i] });
                    }
                }
                return data;
            } catch (e) {
                return null;
            }
        }

        async function fetchYahooShares(ticker) {
            const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${ticker}?modules=defaultKeyStatistics`;

            try {
                const res = await fetchWithProxy(url);
                if (!res) return 0;

                const json = await res.json();

                let result = null;
                if (json.quoteSummary && json.quoteSummary.result) {
                    result = json.quoteSummary.result[0];
                } else if (json.contents) {
                    try {
                        const inner = JSON.parse(json.contents);
                        if (inner.quoteSummary && inner.quoteSummary.result) result = inner.quoteSummary.result[0];
                    } catch (e) { }
                }

                if (!result) return 0;

                const shares = result.defaultKeyStatistics.sharesOutstanding.raw;
                return shares || 0;
            } catch (e) {
                return 0;
            }
        }

        function calculatePerformance(data) {
            if (data.length < 50) return 0;
            // ~60 days lookback
            let lookbackIdx = data.length - 1 - 60;
            if (lookbackIdx < 0) lookbackIdx = 0;

            const startPrice = data[lookbackIdx].close;
            const endPrice = data[data.length - 1].close;

            if (startPrice === 0) return 0;
            return (endPrice / startPrice);
        }

        function resetUI(btn, loader) {
            // loader.style.display = 'none'; // Keep log visible on failure
            btn.disabled = false;
            btn.innerText = 'ğŸ” ì¡°íšŒí•˜ê¸°';
        }

        function calculateRanksAndSort() {
            globalData.sort((a, b) => b.RS - a.RS);
            const sortedByMC = [...globalData].sort((a, b) => b.MarketCap - a.MarketCap);
            const rankMap = {};
            sortedByMC.forEach((item, idx) => {
                rankMap[item.Ticker] = idx + 1;
            });
            globalData.forEach(item => {
                item.MarketCapRank = rankMap[item.Ticker];
            });
            globalData.sort((a, b) => b.RS - a.RS);
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td><strong>${item.Ticker}</strong></td>
                <td>${Number(item.MarketCap).toLocaleString()}</td>
                <td>${item.MarketCapRank}</td>
                <td class="${item.RS > 0 ? 'rs-pos' : 'rs-neg'}">${item.RS.toFixed(4)}</td>
                <td>${item.Sector}</td>
                <td>${item.Industry}</td>
            `;
                tbody.appendChild(tr);
            });
        }

        function sortTable(key) {
            if (sortDir.key === key) sortDir.asc = !sortDir.asc;
            else { sortDir.key = key; sortDir.asc = true; }

            globalData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
                if (typeof valA === 'string') valA = valA.toUpperCase();
                if (typeof valB === 'string') valB = valB.toUpperCase();

                if (valA < valB) return sortDir.asc ? -1 : 1;
                if (valA > valB) return sortDir.asc ? 1 : -1;
                return 0;
            });
            renderTable(globalData);
        }

        async function downloadExcel() {
            if (globalData.length === 0) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            try {
                const res = await fetch('/api/create_excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: globalData })
                });
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `RS_Scanner_${new Date().toISOString().slice(0, 10)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (e) {
                alert('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
            }
        }
    </script>

</body>

</html>